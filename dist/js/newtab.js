/*! (c) Philipp König under GPL-3.0 */
(e=>{"use strict";e.EntryHelper=function(e){let t=!1,l={},a={},r={},n={bookmarks:{},directories:{},pinned:{}};this.init=(e=>(t=!0,new Promise(t=>{this.update(e).then(t)}))),this.initOnce=(()=>new Promise(e=>{t?e():this.init().then(e)})),this.getAmount=(t=>{if(i(),0===Object.keys(l).length&&(l=e.helper.model.getData("u/entryAmounts")),l&&l[t]){let e=l[t].visible;return a.showHidden&&(e+=l[t].hidden),e}return null}),this.getAllDataByType=(e=>Object.values(n[e]||{})),this.getDataById=(e=>{let t=null;return"object"==typeof n.bookmarks[e]?(t=n.bookmarks[e],"object"==typeof n.pinned[e]&&(t.pinnedIndex=n.pinned[e].index)):"object"==typeof n.directories[e]&&(t=n.directories[e]),t}),this.addData=((e,t,l)=>{"object"==typeof n.bookmarks[e]?("pinnedIndex"===t&&"object"==typeof n.pinned[e]&&(n.pinned[e].index=l),n.bookmarks[e][t]=l):"object"==typeof n.directories[e]&&(n.directories[e][t]=l)}),this.isSeparator=(e=>{let t=!1;if("object"==typeof n.bookmarks[e]){let l=n.bookmarks[e].title.replace(/[^-_]/g,"");t="about:blank"===n.bookmarks[e].url&&l.length===n.bookmarks[e].title.length}return t}),this.isVisible=(e=>{let t=!1;return"object"==typeof n.bookmarks[e]?t=!1===n.bookmarks[e].hidden:"object"==typeof n.directories[e]&&(t=!1===n.directories[e].hidden),t}),this.update=((t=null)=>new Promise(a=>{i();let o=[e.helper.model.call("viewAmounts")];null===t&&o.push(e.helper.model.call("bookmarks",{id:0})),Promise.all(o).then(i=>{r=i[0],null===t&&i[1]&&i[1].bookmarks&&i[1].bookmarks[0]&&i[1].bookmarks[0].children&&(t=i[1].bookmarks[0].children),n={bookmarks:{},directories:{},pinned:{}},l={bookmarks:{visible:0,hidden:0},directories:{visible:0,hidden:0},pinned:{visible:0,hidden:0}},s(t),e.helper.model.setData({"u/entryAmounts":l}),a()})}));let i=()=>{a=e.helper.model.getData(["u/hiddenEntries","u/additionalInfo","u/pinnedEntries","u/showHidden"])},s=(e,t=[],l=!1)=>{e.forEach(e=>{let n=[...t];"0"!==e.parentId&&n.push(e.parentId),e.additionalInfo=a.additionalInfo[e.id]||{},e.hidden=l||!0===a.hiddenEntries[e.id],e.parents=n,e.views={startDate:+new Date(Math.max(e.dateAdded,r.counterStartDate)),total:0},e.url?d(e):e.children&&o(e)})},o=e=>{e.childrenAmount={bookmarks:0,directories:0,total:0},e.parents.forEach(e=>{n.directories[e].childrenAmount.directories++}),n.directories[e.id]=e,s(e.children,e.parents,e.hidden),e.isDir=!0,e.childrenAmount.total=e.childrenAmount.bookmarks+e.childrenAmount.directories,e.views.perMonth=Math.round(e.views.total/h(e.views.startDate)*100)/100,l.directories[e.hidden?"hidden":"visible"]++},d=e=>{let t=0,i=0;if(r.viewAmounts[e.id]&&(t=r.viewAmounts[e.id].c,i=r.viewAmounts[e.id].d||0),e.views.total=t,e.views.lastView=i,e.views.perMonth=Math.round(t/h(e.views.startDate)*100)/100,e.parents.forEach(e=>{n.directories[e]&&(n.directories[e].childrenAmount.bookmarks++,n.directories[e].views.total+=t,n.directories[e].views.lastView=Math.max(n.directories[e].views.lastView||0,i))}),e.pinned=!1,n.bookmarks[e.id]=e,!1===this.isSeparator(e.id)&&l.bookmarks[e.hidden?"hidden":"visible"]++,a.pinnedEntries[e.id]){e.pinned=!0;let t=Object.assign({},e);t.index=a.pinnedEntries[e.id].index,delete t.parents,delete t.parentId,n.pinned[e.id]=t,l.pinned[e.hidden?"hidden":"visible"]++}},h=e=>Math.max(1,Math.round((+new Date-e)/2627999942.4))},e.EditHelper=function(t){let l=!1;this.init=(async()=>{a(),e("<a />").addClass(e.cl.newtab.edit).appendTo(t.elm.body),location.href.search(/#edit$/i)>-1&&i()}),this.isEditMode=(()=>l);let a=()=>{t.elm.body.on("click","a."+e.cl.newtab.edit,e=>{e.preventDefault(),l||i()}).on("click","menu."+e.cl.newtab.infoBar+" > a",t=>{t.preventDefault();let l=e(t.currentTarget);l.hasClass(e.cl.newtab.cancel)?n():l.hasClass(e.cl.newtab.save)&&r().then(()=>{n()})})},r=()=>new Promise(l=>{let a=[];t.elm.topNav.find("a."+e.cl.newtab.link).forEach(t=>{let l=e(t).text().trim(),r=(e(t).data("href")||e(t).attr("href")).trim();l&&l.length>0&&r&&r.length>0&&a.push({label:l,url:r})});let r=+new Date,n=t.helper.template.loading().appendTo(t.elm.body);t.elm.body.addClass(e.cl.loading),t.helper.model.setData({"n/searchEngine":t.elm.search.wrapper.children("select")[0].value,"n/topPagesType":t.elm.topPages.children("select")[0].value,"n/shortcuts":a}).then(()=>e.delay(Math.max(0,1e3-(+new Date-r)))).then(()=>{t.elm.body.removeClass(e.cl.loading),n.remove(),l()})}),n=()=>{l=!1,history.pushState({},null,location.href.replace(/#edit/g,"")),t.elm.body.removeClass(e.cl.newtab.edit),t.elm.search.wrapper.children("select").remove(),t.elm.topPages.children("select").remove(),t.elm.topNav.find("a:not(."+e.cl.newtab.link+")").remove(),t.helper.search.updateSearchEngine(t.helper.model.getData("n/searchEngine")),t.helper.topPages.setType(t.helper.model.getData("n/topPagesType")),t.helper.shortcuts.refreshEntries(),e.delay(500).then(()=>{e("menu."+e.cl.newtab.infoBar).remove()})},i=()=>{l=!0,history.pushState({},null,location.href.replace(/#edit/g,"")+"#edit"),e("<menu />").addClass(e.cl.newtab.infoBar).append("<a class='"+e.cl.newtab.cancel+"'>"+t.helper.i18n.get("overlay_cancel")+"</a>").append("<a class='"+e.cl.newtab.save+"'>"+t.helper.i18n.get("settings_save")+"</a>").appendTo(t.elm.body),e.delay().then(()=>{t.elm.body.addClass(e.cl.newtab.edit),h(),d(),s(),e.delay(500).then(()=>{e(window).trigger("resize")})})},s=()=>{let l=["<a class='"+e.cl.newtab.edit+"' />","<a class='"+e.cl.newtab.remove+"' />","<a "+e.attr.position+"='left' />","<a "+e.attr.position+"='right' />"];t.elm.topNav.find("> ul > li").forEach(t=>{e(t).append(l)}),e("<a class='"+e.cl.newtab.add+"' />").prependTo(t.elm.topNav),t.elm.topNav.off("click.edit").on("click.edit","a."+e.cl.newtab.edit,t=>{t.stopPropagation();let l=e(t.currentTarget).parent("li");o(l)}).on("click.edit","a."+e.cl.newtab.add,()=>{let a=e("<li />").append("<a class='"+e.cl.newtab.link+"'>&nbsp;</a>").append(l).prependTo(t.elm.topNav.children("ul"));e.delay().then(()=>{o(a)})}).on("click.edit","a."+e.cl.newtab.remove,t=>{e(t.currentTarget).parent("li").remove()}).on("click.edit","a["+e.attr.position+"]",t=>{let l=e(t.currentTarget).attr(e.attr.position),a=e(t.currentTarget).parent("li");switch(l){case"left":a.prev("li").length()>0&&a.insertBefore(a.prev("li"));break;case"right":a.next("li").length()>0&&a.insertAfter(a.next("li"))}}).on("click.edit","> ul > li > div",e=>{"BUTTON"!==e.target.tagName&&e.stopPropagation()}),e(document).off("click.edit").on("click.edit",()=>{t.elm.topNav.find("> ul > li > div").remove()})},o=l=>{t.elm.topNav.find("> ul > li > div").remove();let a=l.children("a."+e.cl.newtab.link).eq(0);e("<div />").append("<label>"+t.helper.i18n.get("overlay_bookmark_title")+"</label>").append("<input type='text' value='"+a.text().trim().replace(/'/g,"&#x27;")+"' "+e.attr.type+"='label' />").append("<label>"+t.helper.i18n.get("overlay_bookmark_url")+"</label>").append("<input type='text' value='"+(a.data("href")||a.attr("href")).trim().replace(/'/g,"&#x27;")+"' "+e.attr.type+"='url' />").append("<button type='submit'>"+t.helper.i18n.get("overlay_close")+"</button>").appendTo(l).find("input[type='text']").on("change input",t=>{let l=t.currentTarget.value.trim();switch(e(t.currentTarget).attr(e.attr.type)){case"url":a.removeAttr("href").removeData("href"),l&&l.length>0&&(l.startsWith("chrome://")||l.startsWith("chrome-extension://")?a.data("href",l):(0!==l.search(/^\w+:\/\//)&&(l="http://"+l),a.attr("href",l)));break;case"label":l&&l.length>0?a.text(l.trim()):a.html("&nbsp;")}})},d=()=>{let l=e("<select />").prependTo(t.elm.topPages),a=t.helper.topPages.getAllTypes(),r=t.helper.model.getData("n/topPagesType");Object.keys(a).forEach(n=>{let i=t.helper.i18n.get("newtab_top_pages_"+a[n]);e("<option value='"+n+"' "+(r===n?"selected":"")+" />").text(i).appendTo(l)}),l.on("input change",e=>{t.helper.topPages.setType(e.currentTarget.value)})},h=()=>{let l=e("<select />").appendTo(t.elm.search.wrapper),a=t.helper.search.getSearchEngineList(),r=t.helper.model.getData("n/searchEngine");Object.entries(a).forEach(([t,a])=>{e("<option value='"+t+"' "+(r===t?"selected":"")+" />").text(a.name).appendTo(l)}),l.on("input change",e=>{t.helper.search.updateSearchEngine(e.currentTarget.value)})}},e.FallbackHelper=function(t){this.init=(async()=>{let r=new URL(location.href).searchParams.get("type");null!==r&&(t.elm.topPages.addClass(e.cl.hidden),t.elm.fallbackInfo.addClass(e.cl.active),n(r),l(r),"new_tab"!==r&&"fallback"!==r||!1!==t.helper.model.getData("n/override")||a(),t.helper.model.call("trackEvent",{category:"newtab",action:"fallback",label:r,always:!0}))});let l=e=>{t.elm.fallbackInfo.children("a").on("click",t=>{t.preventDefault();let l="general";switch(e){case"notWhitelisted":case"blacklisted":l="filter"}chrome.tabs.create({url:chrome.extension.getURL("html/settings.html#feedback_error_"+l)})})},a=()=>{let l=e("<div />").appendTo(t.elm.fallbackInfo),a=t.helper.checkbox.get(t.elm.body,{},"checkbox","switch").appendTo(l);e("<span />").html(t.helper.i18n.get("newtab_fallback_set_as_new_tab")).insertAfter(a),a.children("input[type='checkbox']").on("change",e=>{e.currentTarget.checked?chrome.permissions.request({permissions:["tabs","topSites"]},e=>{e?r(!0):a.trigger("click")}):r(!1)})},r=e=>{chrome.storage.sync.get(["newtab"],l=>{let a=l.newtab||{};a.override=e,chrome.storage.sync.set({newtab:a},()=>{t.enabledSetAsNewtab=!0,t.helper.model.call("reinitialize")})})},n=l=>{let a={headline:"newtab_fallback_headline_general",desc:"newtab_fallback_desc",link:"newtab_fallback_link"};switch(l){case"new_tab":case"system":case"extension_page":case"webstore":a.headline="newtab_fallback_headline_"+l;break;case"notWhitelisted":case"blacklisted":a.headline="newtab_fallback_headline_url_filter"}e("<h2 />").text(t.helper.i18n.get(a.headline)).appendTo(t.elm.fallbackInfo),e("<p />").text(t.helper.i18n.get(a.desc)).appendTo(t.elm.fallbackInfo),e("<a />").text(t.helper.i18n.get(a.link)).appendTo(t.elm.fallbackInfo)}},e.SearchHelper=function(t){let l={},a=null,r={},n={google:{name:"Google",url:"https://www.google.com/",queryUrl:"https://www.google.com/search?q={1}",sorting:10},bing:{name:"Bing",url:"https://www.bing.com/",queryUrl:"https://www.bing.com/search?q={1}",sorting:20},yahoo:{name:"Yahoo",url:"https://search.yahoo.com/",queryUrl:"https://search.yahoo.com/search?p={1}",sorting:30,lang:{de:{url:"https://de.search.yahoo.com/",queryUrl:"https://de.search.yahoo.com/search?p={1}"},jp:{url:"https://search.yahoo.co.jp/",queryUrl:"https://search.yahoo.co.jp/search?p={1}"}}},duckduckgo:{name:"DuckDuckGo",url:"https://duckduckgo.com/",queryUrl:"https://duckduckgo.com/?q={1}",sorting:40},yandex:{name:"Yandex",url:"https://yandex.com/",queryUrl:"https://yandex.com/search/?text={1}",sorting:50,lang:{ru:{name:"Яндекс",url:"https://yandex.ru/",queryUrl:"https://yandex.ru/search/?text={1}",sorting:15},uk:{name:"Яндекс",url:"https://yandex.ua/",queryUrl:"https://yandex.ua/search/?text={1}",sorting:15},tr:{url:"https://yandex.com.tr/",queryUrl:"https://yandex.com.tr/search/?text={1}",sorting:15}}},baidu:{name:"Baidu",url:"https://www.baidu.com/",queryUrl:"https://www.baidu.com/s?wd={1}",sorting:60,lang:{"zh-CN":{name:"百度",sorting:15}}}};this.init=(async()=>{i(),d(),this.updateSearchEngine(t.helper.model.getData("n/searchEngine"))}),this.updateSearchEngine=(e=>{if(r[e]){a=e;let l=t.helper.i18n.get("newtab_search_placeholder",[r[e].name]);t.elm.search.field.attr("placeholder",l)}}),this.getSearchEngineList=(()=>r);let i=()=>{let e=t.helper.i18n.getUILanguage(),l=[];Object.entries(n).forEach(([t,a])=>{let r={alias:t,name:a.name,url:a.url,queryUrl:a.queryUrl,sorting:a.sorting};a.lang&&a.lang[e]&&Object.entries(a.lang[e]).forEach(([e,t])=>{r[e]=t}),r.name&&r.url&&r.queryUrl&&l.push(r)}),l.sort((e,t)=>(e.sorting||9999)-(t.sorting||9999)),r={},l.forEach(e=>{r[e.alias]=e})},s=l=>{let a=e("ul."+e.cl.newtab.suggestions+" > li."+e.cl.active),r="next"===l?0:-1;a.length()>0&&(r=a.prevAll("li").length()+("next"===l?1:-1),a.removeClass(e.cl.active));let n=!1;if(r>=0){let l=e("ul."+e.cl.newtab.suggestions+" > li").eq(r);l.length()>0&&(n=!0,l.addClass(e.cl.active),t.elm.search.field[0].value=l.text().trim())}!1===n&&(t.elm.search.field[0].value=t.elm.search.field.data("typedVal")||"")},o=e=>{e&&e.trim().length>0&&(0===e.search(/https?\:\/\//)||0===e.search(/s?ftps?\:\/\//)||0===e.search(/chrome\:\/\//)?chrome.tabs.update({url:e}):r[a]&&chrome.tabs.update({url:r[a].queryUrl.replace("{1}",encodeURIComponent(e))}))},d=()=>{t.elm.search.submit.on("click",e=>{e.preventDefault(),e.stopPropagation();let l=t.elm.search.field[0].value;l&&l.trim().length>0?o(l):r[a]&&chrome.tabs.update({url:r[a].url})}),t.elm.search.field.on("keyup click",a=>{a.preventDefault(),a.stopPropagation();let r=a.currentTarget.value,n=event.which||event.keyCode;13===n?o(r):40===n?s("next"):38===n?s("prev"):(t.elm.search.field.data("typedVal",r),(t=>new Promise(a=>{if(t)if(l[t])a(l[t]);else{let r=encodeURIComponent(t),n=(e=[])=>{l[t]=e,a(e)};e.xhr("http://google.com/complete/search?client=chrome&q="+r,{responseType:"json"}).then(e=>{try{if(e.response&&e.response[0]===t){let t=[],l=[];e.response[1].forEach((a,r)=>{"NAVIGATION"===e.response[4]["google:suggesttype"][r]?t.push({type:"url",label:a}):l.push({type:"word",label:a})}),n(t.concat(l))}}catch(e){n()}},()=>{n()})}else a([])}))(r).then(l=>{if(e("ul."+e.cl.newtab.suggestions).remove(),l.length>0){let a=e("<ul />").addClass(e.cl.newtab.suggestions).insertAfter(t.elm.search.field);l.some((t,l)=>{if(e("<li />").attr(e.attr.type,t.type).text(t.label).appendTo(a),l>4)return!0}),a.css({top:t.elm.search.field[0].offsetTop+"px",left:t.elm.search.field[0].offsetLeft+"px"})}}))}),e(document).on("mousemove","ul."+e.cl.newtab.suggestions+" > li",t=>{e("ul."+e.cl.newtab.suggestions+" > li").removeClass(e.cl.active),e(t.currentTarget).addClass(e.cl.active)}).on("click","ul."+e.cl.newtab.suggestions+" > li",l=>{l.preventDefault(),l.stopPropagation();let a=e(l.currentTarget).text().trim();t.elm.search.field[0].value=a,o(a)}),e(document).on("click",()=>{e("ul."+e.cl.newtab.suggestions).remove(),!1===t.helper.edit.isEditMode()&&t.elm.search.field[0].focus()}),e(window).on("resize",()=>{e("ul."+e.cl.newtab.suggestions).remove()})}},e.ShortcutsHelper=function(t){this.init=(async()=>{this.refreshEntries(),l()}),this.refreshEntries=(()=>{let l=t.helper.model.getData("n/shortcuts");t.elm.topNav.children("ul").remove();let a=e("<ul />").appendTo(t.elm.topNav);l&&l.length>0&&l.forEach(t=>{let l=e("<li />").appendTo(a),r=e("<a />").addClass(e.cl.newtab.link).text(t.label).appendTo(l);t.url.startsWith("chrome://")||t.url.startsWith("chrome-extension://")?r.data("href",t.url):r.attr("href",t.url)})});let l=()=>{t.elm.topNav.on("mousedown","a."+e.cl.newtab.link,l=>{let a=e(l.currentTarget).data("href");a&&(l.preventDefault(),t.helper.model.call("openLink",{href:a,newTab:2===l.which,position:t.helper.model.getData("b/newTabPosition"),active:2!==l.which}))})}},e.TopPagesHelper=function(t){let l=null,a=!1,r={topPages:"default",mostUsed:"most_used",recentlyUsed:"recently_used",pinnedEntries:"pinned_entries",hidden:"hidden"};this.init=(async()=>{n(),t.elm.topPages.html("<ul />"),this.setType(t.helper.model.getData("n/topPagesType")),setInterval(()=>{document.hidden&&s()},12e4)}),this.getAllTypes=(()=>r),this.setType=(e=>{l===e&&"hidden"!==l||(l=e,s())}),this.handleWindowResize=(()=>{let e=i(),l=t.elm.topPages.children("ul").data("total");e.total!==l&&s()});let n=()=>{e(window).on("resize.topPages",()=>{this.handleWindowResize()})},i=()=>{let l={total:8,rows:2},a={w:t.elm.content[0].offsetWidth||window.innerWidth,h:t.elm.content[0].offsetHeight||window.innerHeight},r=e("menu."+e.cl.newtab.infoBar);return r.length()>0&&(a.h-=r[0].offsetHeight),a.w>650?l.total=8:a.w>490?l.total=6:a.w>340?l.total=4:l.total=0,a.h<330?l.total=0:a.h<470&&(l.total/=2,l.rows=1),l},s=()=>{t.elm.topPages.children("ul").removeClass(e.cl.visible),"hidden"===l?!1===t.helper.edit.isEditMode()&&t.elm.topPages.children("ul").data("total",0).html(""):!1===a&&(a=!0,Promise.all([d(),e.delay(200)]).then(([l])=>{let a=i();return t.elm.topPages.children("ul").html("").data("total",a.total).attr(e.attr.newtab.perRow,a.total/a.rows),l.forEach(l=>{let a=e("<li />").appendTo(t.elm.topPages.children("ul")),r=e("<a />").attr({href:l.url,title:l.title}).appendTo(a),n=e("<span />").text(l.title).appendTo(r);t.helper.model.call("favicon",{url:l.url}).then(e=>{e.img&&n.prepend("<img src='"+e.img+"' />")});let i=e("<img />").appendTo(r);!1===t.helper.utility.isUrlOnBlacklist(l.url)&&t.helper.model.call("thumbnail",{url:l.url}).then(t=>{t.img&&i.attr("src",t.img).addClass(e.cl.visible)})}),e.delay(100)}).then(()=>{t.elm.topPages.children("ul").addClass(e.cl.visible),a=!1}))},o=()=>new Promise(e=>{t.helper.entry.init().then(()=>{e()})}),d=()=>new Promise(e=>{let t=i();if(t.total>0)switch(l){case"mostUsed":case"recentlyUsed":o().then(()=>{let t=c(l);e(t)});break;case"pinnedEntries":o().then(()=>{let t=h();e(t)});break;case"topPages":default:chrome.topSites&&chrome.topSites.get&&chrome.topSites.get(l=>{if(void 0===chrome.runtime.lastError&&l){let a=l.slice(0,t.total);e(a)}else e([])})}else e([])}),h=()=>{let e=t.helper.entry.getAllDataByType("pinned"),l=t.helper.model.getData(["u/showHidden"]),a=i(),r=[];return e.some(e=>{if((l.showHidden||t.helper.entry.isVisible(e.id))&&!1===t.helper.entry.isSeparator(e.id)&&(r.push(e),r.length>=a.total))return!0}),r},c=e=>{let l=i(),a=t.helper.entry.getAllDataByType("bookmarks"),r=t.helper.model.getData(["u/showHidden","u/mostViewedPerMonth"]),n=t.helper.i18n.getLocaleSortCollator();"recentlyUsed"===e?a.sort((e,l)=>{let a=t.helper.entry.getDataById(e.id),r=t.helper.entry.getDataById(l.id),i=a?a.views.lastView:0,s=r?r.views.lastView:0;return i===s?n.compare(e.title,l.title):s-i}):"mostUsed"===e&&a.sort((e,l)=>{let a=t.helper.entry.getDataById(e.id),i=t.helper.entry.getDataById(l.id),s=a?a.views[r.mostViewedPerMonth?"perMonth":"total"]:0,o=i?i.views[r.mostViewedPerMonth?"perMonth":"total"]:0;return s===o?n.compare(e.title,l.title):o-s});let s=[];return a.some(e=>{if((r.showHidden||t.helper.entry.isVisible(e.id))&&!1===t.helper.entry.isSeparator(e.id)&&0!==e.url.search(/^file:\/\//)&&(s.push(e),s.length>=l.total))return!0}),s}};(new function(){this.elm={body:e("body"),title:e("head > title"),content:e("section#content"),topNav:e("section#content > nav"),search:{wrapper:e("div#search"),field:e("div#search > input[type='text']"),submit:e("div#search > button[type='submit']")},fallbackInfo:e("div#fallbackInfo"),topPages:e("div#topPages")},this.enabledSetAsNewtab=!1,this.run=(()=>{a(),t();let r=this.helper.template.loading().appendTo(this.elm.body);this.elm.body.addClass(e.cl.initLoading),this.helper.model.init().then(()=>{let t=this.helper.model.getData(["a/darkMode","a/highContrast","b/sidebarPosition"]);return!0===t.darkMode?this.elm.body.addClass(e.cl.page.darkMode):!0===t.highContrast&&this.elm.body.addClass(e.cl.page.highContrast),this.elm.body.attr(e.attr.position,t.sidebarPosition),this.helper.i18n.init()}).then(()=>(this.elm.body.parent("html").attr("dir",this.helper.i18n.isRtl()?"rtl":"ltr"),this.helper.font.init(),this.helper.stylesheet.init(),this.helper.stylesheet.addStylesheets(["newtab"],e(document)),this.helper.i18n.parseHtml(document),this.helper.topPages.init(),this.helper.search.init(),this.helper.shortcuts.init(),this.helper.fallback.init(),this.helper.edit.init(),l(),e.delay(500))).then(()=>{r.remove(),this.elm.body.removeClass([e.cl.building,e.cl.initLoading]),e(window).trigger("resize")})});let t=()=>{this.helper={model:new e.ModelHelper(this),template:new e.TemplateHelper(this),i18n:new e.I18nHelper(this),font:new e.FontHelper(this),stylesheet:new e.StylesheetHelper(this),checkbox:new e.CheckboxHelper(this),utility:new e.UtilityHelper(this),search:new e.SearchHelper(this),entry:new e.EntryHelper(this),shortcuts:new e.ShortcutsHelper(this),topPages:new e.TopPagesHelper(this),fallback:new e.FallbackHelper(this),edit:new e.EditHelper(this)}},l=async()=>{chrome.extension.onMessage.addListener(e=>{e&&e.action&&"reinitialize"===e.action&&!1===this.enabledSetAsNewtab&&location.reload(!0)}),this.helper.model.getData("n/autoOpen")&&e(window).on("resize",()=>{if(this.elm.sidebar&&this.elm.sidebar.iframe&&this.elm.sidebar.sidebar){let t=this.elm.sidebar.sidebar.realWidth();window.innerWidth-t>=500?(this.elm.sidebar.sidebar.addClass(e.cl.sidebar.permanent),t>0&&this.elm.content.addClass(e.cl.newtab.smallContent),e(document).trigger(e.opts.events.openSidebar),e.delay(500).then(()=>{e(document).trigger("click")})):(this.elm.sidebar.sidebar.removeClass(e.cl.sidebar.permanent),this.elm.content.removeClass(e.cl.newtab.smallContent)),this.helper.topPages.handleWindowResize()}})},a=()=>new Promise(t=>{e("["+e.attr.type+"='script_sidebar']").remove();let l=[e.opts.events.loaded,e.opts.events.elementsCreated].join(" ");e(document).off(l).on(l,t=>{this.elm.sidebar=t.detail.elm,e(window).trigger("resize")}),e.opts.manifest.content_scripts[0].css.forEach(t=>{e("<link />").attr({href:chrome.extension.getURL(t),type:"text/css",rel:"stylesheet",[e.attr.type]:"script_sidebar"}).appendTo("head")});let a=(l=0)=>{let r=e.opts.manifest.content_scripts[0].js[l];if(void 0!==r){let t=document.createElement("script");document.head.appendChild(t),t.onload=(()=>a(l+1)),t.src="/"+r,e(t).attr(e.attr.type,"script_sidebar")}else t()};a()})}).run()})(jsu);